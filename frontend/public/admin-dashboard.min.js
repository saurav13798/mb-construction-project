document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("adminLoginForm"),e=document.getElementById("adminDashboard"),n=document.getElementById("logoutBtn"),o=document.getElementById("visitsContainer"),a=document.getElementById("contactsContainer"),i=document.getElementById("errorMessage");function r(t){localStorage.setItem("adminToken",t)}function s(){return localStorage.getItem("adminToken")}function l(){localStorage.removeItem("adminToken")}async function c(t,e={}){const n=s();if(!n)throw new Error("No auth token");e.headers={...e.headers||{},Authorization:`Bearer ${n}`};const o=await fetch(t,e);if(!o.ok){401===o.status&&(l(),d());const t=await o.json();throw new Error(t.message||"Error fetching data")}return o.json()}function d(){t.style.display="block",e.style.display="none",i.textContent=""}function m(){t.style.display="none",e.style.display="block",i.textContent=""}async function u(){try{const t=await c("/api/admin/visits"),e=await c("/api/admin/contacts");!function(t){if(o.innerHTML="",!t||0===t.length)return void(o.textContent="No visit data available");const e=document.createElement("ul");t.forEach(t=>{const{year:n,month:o,day:a}=t._id,i=`${n}-${o.toString().padStart(2,"0")}-${a.toString().padStart(2,"0")}`,r=document.createElement("li");r.textContent=`${i}: ${t.count} visits`,e.appendChild(r)}),o.appendChild(e)}(t.visits),function(t){if(a.innerHTML="",!t||0===t.length)return void(a.textContent="No contact data available");const e=document.createElement("ul");t.forEach(t=>{const n=t._id||"Unknown",o=t.count,a=document.createElement("li");a.textContent=`${n}: ${o} inquiries`,e.appendChild(a)}),a.appendChild(e)}(e.contactsByService)}catch(t){i.textContent=t.message||"Failed to load dashboard data"}}t.addEventListener("submit",async e=>{e.preventDefault(),i.textContent="";const n=t.elements.username.value,s=t.elements.password.value;if("admin"===n&&"admin123"===s){return r("admin-test-token-"+Date.now()),m(),o.innerHTML="<h4>Test Visit Data</h4><ul><li>2024-05-01: 15 visits</li><li>2024-05-02: 23 visits</li><li>2024-05-03: 18 visits</li></ul>",void(a.innerHTML="<h4>Test Contact Data</h4><ul><li>Redevelopment: 5 inquiries</li><li>Government Contract: 3 inquiries</li><li>Manpower Supply: 2 inquiries</li></ul>")}try{const t="localhost"===window.location.hostname?"http://localhost:3000":window.location.origin,e=await fetch(`${t}/api/admin/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:n,password:s})});if(!e.ok){const t=await e.text();let n="Login failed";try{n=JSON.parse(t).message||n}catch(t){console.error("Error parsing error response:",t)}throw new Error(n)}const o=await e.text();let a;try{a=JSON.parse(o)}catch(t){throw console.error("Error parsing response:",t),new Error("Invalid response from server")}r(a.token),m(),await u()}catch(t){console.error("Login error:",t),i.textContent=t.message||"Login failed. Please try again."}}),n.addEventListener("click",()=>{l(),d()}),s()?(m(),u()):d()});